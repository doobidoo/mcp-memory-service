{
  "id": "snapshot_1767101955765_28vyknnn3",
  "approvalId": "approval_1767100434402_lgeh9xydl",
  "approvalTitle": "tasks.md - Codebase Remediation Tasks",
  "version": 2,
  "timestamp": "2025-12-30T13:39:15.765Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Tasks Document: Codebase Remediation\n\n## Phase 0: Security Triage (Immediate)\n\n- [ ] 0.1. Remove vulnerable OAuth dependencies from pyproject.toml\n  - File: pyproject.toml\n  - Remove authlib, python-jose from dependencies\n  - Run `uv lock` to update lockfile\n  - Purpose: Eliminate 3 CRITICAL security vulnerabilities\n  - _Leverage: None (deletion only)_\n  - _Requirements: REQ-1_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Security Engineer specializing in Python dependency management | Task: Remove authlib and python-jose from pyproject.toml dependencies following REQ-1, run uv lock to regenerate lockfile | Restrictions: Do not remove any other dependencies, verify removal doesn't break imports | Success: Dependencies removed, lockfile updated, no import errors for remaining code | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts showing files modified, then mark [x] when complete_\n\n- [ ] 0.2. Fix anonymous access permissions\n  - File: src/mcp_memory_service/config.py (or equivalent)\n  - Change anonymous access from admin to read-only\n  - Purpose: Prevent unauthorized write access\n  - _Leverage: Existing auth configuration_\n  - _Requirements: REQ-1_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Security Engineer specializing in access control | Task: Locate anonymous access configuration and change default from admin to read-only following REQ-1 | Restrictions: Do not remove anonymous access entirely, only restrict permissions | Success: Anonymous users can read but not write, authenticated users retain full access | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n- [ ] 0.3. Fix CORS default configuration\n  - File: src/mcp_memory_service/config.py\n  - Change CORS default from ['*'] to []\n  - Purpose: Prevent cross-origin access by default\n  - _Leverage: pydantic-settings configuration_\n  - _Requirements: REQ-1_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Security Engineer specializing in web security | Task: Locate CORS configuration and change default allowed_origins from ['*'] to [] following REQ-1 | Restrictions: Do not break existing explicit CORS configurations | Success: Default CORS is restrictive, explicit origins still work when configured | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n- [ ] 0.4. Delete mDNS discovery code\n  - Files: Delete discovery/, remove zeroconf from dependencies\n  - Remove all mDNS/service discovery functionality\n  - Purpose: Eliminate network exposure risk\n  - _Leverage: None (deletion only)_\n  - _Requirements: REQ-1_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Security Engineer | Task: Delete discovery/ directory and remove zeroconf from pyproject.toml following REQ-1 | Restrictions: Verify no remaining imports reference discovery module | Success: discovery/ deleted, zeroconf removed, no import errors | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n## Phase 1: Dead Code Removal\n\n- [ ] 1.1. Delete unused server implementations\n  - Files: Delete server.py, mcp_server.py (keep unified_server.py temporarily)\n  - Purpose: Remove duplicate entry points\n  - _Leverage: None (deletion only)_\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer | Task: Delete server.py and mcp_server.py following REQ-2 | Restrictions: Keep unified_server.py as temporary entry point, verify no imports break | Success: Files deleted, service still starts via unified_server.py | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n- [ ] 1.2. Delete consolidation module\n  - Files: Delete consolidation/ directory entirely\n  - Purpose: Remove disabled-by-default feature\n  - _Leverage: None (deletion only)_\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer | Task: Delete consolidation/ directory following REQ-2 | Restrictions: Remove any imports referencing consolidation | Success: Directory deleted, no import errors | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n- [ ] 1.3. Delete sync module\n  - Files: Delete sync/ directory entirely\n  - Purpose: Remove unused synchronization code\n  - _Leverage: None (deletion only)_\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer | Task: Delete sync/ directory following REQ-2 | Restrictions: Remove any imports referencing sync | Success: Directory deleted, no import errors | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n- [ ] 1.4. Delete ingestion module\n  - Files: Delete ingestion/ directory, remove pypdf2/chardet from dependencies\n  - Purpose: Remove document ingestion feature creep\n  - _Leverage: None (deletion only)_\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer | Task: Delete ingestion/ directory and remove pypdf2, chardet from dependencies following REQ-2 | Restrictions: Remove any imports referencing ingestion | Success: Directory deleted, dependencies removed, no import errors | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n- [ ] 1.5. Delete ONNX embedding code\n  - Files: Delete embeddings/onnx_*.py files\n  - Purpose: Remove disabled ONNX embedding option\n  - _Leverage: None (deletion only)_\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer | Task: Delete embeddings/onnx_*.py files following REQ-2 | Restrictions: Keep main embedding code, remove ONNX-specific files only | Success: ONNX files deleted, embedding generation still works | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n- [ ] 1.6. Delete OAuth web components\n  - Files: Delete web/oauth/ directory\n  - Purpose: Remove OAuth UI components\n  - _Leverage: None (deletion only)_\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Frontend Developer | Task: Delete web/oauth/ directory following REQ-2 | Restrictions: Keep other web components intact | Success: OAuth UI deleted, remaining web components work | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n- [ ] 1.7. Delete LM Studio compatibility layer\n  - Files: Delete lm_studio_compat.py\n  - Purpose: Remove unused compatibility code\n  - _Leverage: None (deletion only)_\n  - _Requirements: REQ-2_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer | Task: Delete lm_studio_compat.py following REQ-2 | Restrictions: Remove any imports referencing lm_studio_compat | Success: File deleted, no import errors | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n## Phase 2: Storage Consolidation\n\n- [ ] 2.1. Delete Cloudflare storage backend\n  - Files: Delete storage/cloudflare.py\n  - Purpose: Remove unused storage backend\n  - _Leverage: None (deletion only)_\n  - _Requirements: REQ-3_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer | Task: Delete storage/cloudflare.py following REQ-3 | Restrictions: Update storage factory to remove cloudflare option | Success: Backend deleted, factory updated, qdrant/sqlite still work | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n- [ ] 2.2. Delete Hybrid storage backend\n  - Files: Delete storage/hybrid.py\n  - Purpose: Remove race-condition-prone backend\n  - _Leverage: None (deletion only)_\n  - _Requirements: REQ-3_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer | Task: Delete storage/hybrid.py following REQ-3 | Restrictions: Update storage factory to remove hybrid option | Success: Backend deleted, factory updated, qdrant/sqlite still work | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n- [ ] 2.3. Delete HTTP client storage\n  - Files: Delete storage/http_client.py\n  - Purpose: Remove unused HTTP storage client\n  - _Leverage: None (deletion only)_\n  - _Requirements: REQ-3_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer | Task: Delete storage/http_client.py following REQ-3 | Restrictions: Update any imports referencing http_client | Success: File deleted, no import errors | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n- [ ] 2.4. Create BaseStorage Protocol interface\n  - File: src/mcp_memory_service/storage/__init__.py\n  - Define typing.Protocol for storage abstraction\n  - Add storage factory function\n  - Purpose: Establish clean storage contract\n  - _Leverage: Existing storage method signatures_\n  - _Requirements: REQ-3, REQ-5_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Python Architect specializing in Protocol-based interfaces | Task: Create BaseStorage Protocol in storage/__init__.py following REQ-3 and REQ-5, with methods: upsert, search, search_by_tags, list, delete, count, health | Restrictions: Use typing.Protocol not ABC, keep under 100 lines | Success: Protocol defined, factory creates Qdrant or SQLite based on config | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts showing the Protocol definition, then mark [x] when complete_\n\n- [ ] 2.5. Refactor QdrantStorage to implement Protocol\n  - File: src/mcp_memory_service/storage/qdrant.py\n  - Update to implement BaseStorage Protocol\n  - Consolidate to ~600 lines\n  - Purpose: Clean Qdrant implementation\n  - _Leverage: Existing Qdrant operations_\n  - _Requirements: REQ-3, REQ-6_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with Qdrant expertise | Task: Refactor qdrant.py to implement BaseStorage Protocol following REQ-3 and REQ-6 | Restrictions: Keep under 600 lines, maintain all existing functionality | Success: Implements Protocol, passes existing tests, under line limit | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n- [ ] 2.6. Refactor SqliteStorage to implement Protocol\n  - File: src/mcp_memory_service/storage/sqlite.py\n  - Update to implement BaseStorage Protocol\n  - Consolidate to ~400 lines\n  - Purpose: Clean SQLite implementation\n  - _Leverage: Existing SQLite operations_\n  - _Requirements: REQ-3, REQ-6_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with SQLite expertise | Task: Refactor sqlite.py to implement BaseStorage Protocol following REQ-3 and REQ-6 | Restrictions: Keep under 400 lines, maintain all existing functionality | Success: Implements Protocol, passes existing tests, under line limit | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n## Phase 3: Config Collapse\n\n- [ ] 3.1. Create unified CoreSettings class\n  - File: src/mcp_memory_service/config.py\n  - Consolidate core settings into single class\n  - Use pydantic-settings with SecretStr\n  - Purpose: Simplify configuration\n  - _Leverage: Existing config patterns_\n  - _Requirements: REQ-4_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Python Developer with pydantic-settings expertise | Task: Create CoreSettings class in config.py following REQ-4 with storage_backend, embedding_model, embedding_dim, log_level fields | Restrictions: Use pydantic-settings v2, SecretStr for sensitive values, keep total config.py under 200 lines | Success: CoreSettings loads from environment, validates correctly | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n- [ ] 3.2. Create QdrantSettings class\n  - File: src/mcp_memory_service/config.py\n  - Add Qdrant-specific configuration\n  - Purpose: Isolate Qdrant settings\n  - _Leverage: Existing Qdrant config_\n  - _Requirements: REQ-4_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Python Developer | Task: Create QdrantSettings class with host, port, collection_name, api_key (SecretStr) following REQ-4 | Restrictions: Keep in config.py, use SecretStr for api_key | Success: QdrantSettings loads from environment correctly | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n- [ ] 3.3. Create SqliteSettings and ApiSettings classes\n  - File: src/mcp_memory_service/config.py\n  - Add SQLite and API configuration\n  - Purpose: Complete configuration consolidation\n  - _Leverage: Existing config patterns_\n  - _Requirements: REQ-4_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Python Developer | Task: Create SqliteSettings (db_path) and ApiSettings (http_enabled, http_port, cors_origins) classes following REQ-4 | Restrictions: cors_origins must default to [], not ['*'] | Success: All 4 settings classes in config.py under 200 lines total | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n- [ ] 3.4. Delete old configuration classes\n  - Files: Delete unused config files/classes\n  - Update imports throughout codebase\n  - Purpose: Remove configuration bloat\n  - _Leverage: New unified config_\n  - _Requirements: REQ-4_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer | Task: Delete old configuration classes, update all imports to use new config.py classes following REQ-4 | Restrictions: Test that all configuration still loads correctly | Success: Only 4 config classes remain, all imports updated | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n## Phase 4: Core Architecture\n\n- [ ] 4.1. Create Memory dataclass\n  - File: src/mcp_memory_service/memory.py\n  - Define Memory dataclass with all fields\n  - Add content hash generation\n  - Purpose: Establish domain model\n  - _Leverage: Existing memory structure_\n  - _Requirements: REQ-5_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Python Developer | Task: Create Memory dataclass in memory.py with content, content_hash, tags, memory_type, metadata, created_at, updated_at following REQ-5 | Restrictions: Keep under 50 lines, use dataclasses not pydantic | Success: Memory dataclass works with storage backends | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n- [ ] 4.2. Create MemoryService core\n  - File: src/mcp_memory_service/service.py\n  - Implement core business logic\n  - Inject storage and embedding dependencies\n  - Purpose: Establish hexagonal core\n  - _Leverage: Existing business logic_\n  - _Requirements: REQ-5, REQ-6_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Python Architect | Task: Create MemoryService in service.py with store, retrieve, search_by_tag, list_memories, delete, health_check methods following REQ-5 and REQ-6 | Restrictions: NO imports from api/ or storage implementations, only Protocol interface. Keep under 300 lines | Success: Service works with any storage implementing Protocol | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n- [ ] 4.3. Create MCP protocol adapter\n  - File: src/mcp_memory_service/api/mcp.py\n  - Implement FastMCP tool decorators\n  - Add TOON formatting for responses\n  - Purpose: MCP protocol translation\n  - _Leverage: Existing MCP tools, FastMCP_\n  - _Requirements: REQ-5_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: MCP Developer with FastMCP expertise | Task: Create api/mcp.py with @mcp.tool() decorators for store_memory, retrieve_memory, search_by_tag, list_memories, delete_memory, check_database_health following REQ-5 | Restrictions: Only call MemoryService methods, add TOON formatting, keep under 400 lines | Success: All MCP tools work correctly | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n- [ ] 4.4. Create HTTP protocol adapter (optional)\n  - File: src/mcp_memory_service/api/http.py\n  - Implement FastAPI routes\n  - Purpose: HTTP protocol translation for dashboard\n  - _Leverage: Existing HTTP routes, FastAPI_\n  - _Requirements: REQ-5_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: FastAPI Developer | Task: Create api/http.py with FastAPI routes mirroring MCP tools, plus /health endpoint following REQ-5 | Restrictions: Only call MemoryService methods, keep under 300 lines | Success: HTTP API works, /health returns within 100ms | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n- [ ] 4.5. Create main.py bootstrap\n  - File: src/mcp_memory_service/main.py\n  - Wire up DI, lifecycle management\n  - Purpose: Application entry point\n  - _Leverage: Existing startup logic_\n  - _Requirements: REQ-5_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Python Developer | Task: Create main.py with dependency injection, lifecycle hooks, and entry point following REQ-5 | Restrictions: Keep under 150 lines, clean startup/shutdown | Success: Service starts correctly with `uv run memory server` | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n- [ ] 4.6. Delete unified_server.py (final cleanup)\n  - Files: Delete unified_server.py\n  - Update entry points to use main.py\n  - Purpose: Complete architecture transition\n  - _Leverage: New main.py_\n  - _Requirements: REQ-2, REQ-5_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer | Task: Delete unified_server.py and update pyproject.toml entry points to use main.py following REQ-2 and REQ-5 | Restrictions: Verify service still starts correctly | Success: Old server deleted, new entry point works | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n\n## Phase 5: Validation\n\n- [ ] 5.1. Run full test suite\n  - Verify all tests pass\n  - Fix any regressions\n  - Purpose: Validate remediation\n  - _Leverage: pytest_\n  - _Requirements: All_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Engineer | Task: Run pytest on entire test suite, fix any failing tests | Restrictions: Do not skip tests, fix root causes | Success: All tests pass | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts showing test results, then mark [x] when complete_\n\n- [ ] 5.2. Verify line count target\n  - Count lines in src/mcp_memory_service/\n  - Ensure ~2,000 lines (Â±500)\n  - Purpose: Validate reduction goal\n  - _Leverage: wc -l, structure.md limits_\n  - _Requirements: REQ-6_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Developer | Task: Count lines per file vs structure.md limits, verify total ~2000 lines following REQ-6 | Restrictions: All files must be under hard limits | Success: Total under 2500 lines, each file under its limit | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts showing line counts, then mark [x] when complete_\n\n- [ ] 5.3. Security scan\n  - Run security tools (bandit, safety)\n  - Verify no CRITICAL/HIGH vulnerabilities\n  - Purpose: Validate security fixes\n  - _Leverage: bandit, safety_\n  - _Requirements: REQ-1_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Security Engineer | Task: Run bandit and safety on codebase, verify no CRITICAL or HIGH findings following REQ-1 | Restrictions: Fix any findings, don't suppress | Success: Clean security scan | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts showing scan results, then mark [x] when complete_\n\n- [ ] 5.4. Update CLAUDE.md\n  - Reflect new architecture\n  - Update quick start commands\n  - Purpose: Keep documentation current\n  - _Leverage: New structure_\n  - _Requirements: All_\n  - _Prompt: Implement the task for spec codebase-remediation, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Technical Writer | Task: Update CLAUDE.md to reflect new hexagonal architecture, removed features, and simplified configuration | Restrictions: Keep concise, remove references to deleted code | Success: CLAUDE.md accurately describes current state | Instructions: Mark task [-] in tasks.md before starting, use log-implementation tool after completion with artifacts, then mark [x] when complete_\n",
  "fileStats": {
    "size": 24632,
    "lines": 260,
    "lastModified": "2025-12-30T13:13:42.178Z"
  },
  "comments": []
}
