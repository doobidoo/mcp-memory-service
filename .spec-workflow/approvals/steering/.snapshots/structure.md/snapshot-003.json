{
  "id": "snapshot_1767099432114_z5jax9wcl",
  "approvalId": "approval_1767099267233_t2fb0jxcy",
  "approvalTitle": "structure.md - Project Structure (typing.Protocol fixed)",
  "version": 3,
  "timestamp": "2025-12-30T12:57:12.114Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Project Structure\n\n## Conceptual Model\n\n### What Is This Service?\n\nA semantic memory service with ONE core responsibility:\n**Store text → Generate embedding → Persist → Retrieve by similarity/tags**\n\n### Architecture: Hexagonal (Ports & Adapters), Minimized\n\n```\n                    ┌─────────────────────────────┐\n     MCP Client ───→│         api/mcp.py          │\n                    │     (FastMCP adapter)       │\n                    └──────────────┬──────────────┘\n                                   │\n     HTTP Client ──→│         api/http.py         │\n                    │    (FastAPI adapter)        │\n                    └──────────────┬──────────────┘\n                                   │\n                                   ▼\n                    ┌─────────────────────────────┐\n                    │        service.py           │\n                    │                             │\n                    │  THE CORE - Pure business   │\n                    │  logic. Knows NOTHING about │\n                    │  MCP, HTTP, or storage impl │\n                    └──────────────┬──────────────┘\n                                   │\n                                   ▼\n                    ┌─────────────────────────────┐\n                    │    storage/__init__.py      │\n                    │     (BaseStorage port)      │\n                    └──────────────┬──────────────┘\n                           ┌───────┴───────┐\n                           ▼               ▼\n                    ┌────────────┐  ┌────────────┐\n                    │qdrant.py   │  │ sqlite.py  │\n                    │(production)│  │ (dev only) │\n                    └────────────┘  └────────────┘\n```\n\n### Key Principle\n\n**service.py is the heart**. It:\n- Receives domain operations (store/retrieve/search/delete)\n- Generates embeddings (owns the model)\n- Delegates to storage abstraction\n- Returns domain objects\n\nIt knows NOTHING about:\n- Wire protocols (MCP, HTTP, gRPC)\n- Storage implementations (Qdrant, SQLite, Cloudflare)\n- Serialization formats (TOON, JSON)\n\n## Directory Organization\n\n### Target Structure (~2,000 lines total)\n\n```\nmcp-memory-service/\n├── src/\n│   └── mcp_memory_service/\n│       ├── __init__.py            # Version, quick imports\n│       ├── config.py              # 4 Settings classes (~200 lines)\n│       ├── memory.py              # Memory dataclass (~50 lines)\n│       ├── service.py             # MemoryService - THE CORE (~300 lines)\n│       │\n│       ├── storage/               # Persistence adapters\n│       │   ├── __init__.py        # BaseStorage protocol + factory (~100 lines)\n│       │   ├── qdrant.py          # Production adapter (~600 lines)\n│       │   └── sqlite.py          # Dev adapter (~400 lines)\n│       │\n│       ├── api/                   # Protocol adapters\n│       │   ├── __init__.py\n│       │   ├── mcp.py             # FastMCP tools + TOON (~400 lines)\n│       │   └── http.py            # FastAPI routes (~300 lines, optional)\n│       │\n│       └── main.py                # Bootstrap, DI, lifecycle (~150 lines)\n│\n├── tests/\n│   ├── conftest.py\n│   ├── test_service.py            # Core business logic tests\n│   ├── test_storage_qdrant.py\n│   └── test_storage_sqlite.py\n│\n├── Dockerfile\n├── pyproject.toml\n└── CLAUDE.md\n```\n\n### What Each File Does\n\n| File | Responsibility | Dependencies |\n|------|----------------|--------------|\n| `config.py` | Settings from env | pydantic-settings |\n| `memory.py` | Memory domain object | dataclasses |\n| `service.py` | Core business logic | memory, storage (interface only) |\n| `storage/__init__.py` | Storage protocol + factory | typing.Protocol |\n| `storage/qdrant.py` | Qdrant persistence | qdrant-client |\n| `storage/sqlite.py` | SQLite persistence | sqlite-vec |\n| `api/mcp.py` | MCP protocol adapter | fastmcp, service |\n| `api/http.py` | HTTP protocol adapter | fastapi, service |\n| `main.py` | Wiring + lifecycle | everything |\n\n### Directories to DELETE\n\nEverything not in the target structure:\n\n```\n# Dead code\nserver.py, mcp_server.py, unified_server.py\nlm_studio_compat.py\nconsolidation/, discovery/, sync/, ingestion/\nembeddings/onnx_*.py\nweb/oauth/\n\n# Unused storage backends\nstorage/cloudflare.py, storage/hybrid.py, storage/http_client.py\n```\n\n## Naming Conventions\n\n### Files\n- **Modules**: `snake_case.py`\n- **Tests**: `test_<module>.py`\n\n### Code\n- **Classes**: `PascalCase` (e.g., `MemoryService`, `QdrantStorage`)\n- **Functions**: `snake_case` (e.g., `store_memory`, `retrieve_by_similarity`)\n- **Constants**: `UPPER_SNAKE_CASE`\n- **Private**: `_leading_underscore`\n\n## Import Rules\n\n### Order (enforced by ruff)\n1. Standard library\n2. Third-party packages\n3. Local application imports\n\n### Dependency Direction\n```\napi/* → service.py → storage/*\n         ↓\n      memory.py\n         ↓\n      config.py\n```\n\n**Never reverse these arrows.**\n\n## Code Size Targets\n\n| File | Target Lines | Hard Max |\n|------|--------------|----------|\n| `config.py` | 200 | 300 |\n| `memory.py` | 50 | 100 |\n| `service.py` | 300 | 400 |\n| `storage/qdrant.py` | 600 | 800 |\n| `storage/sqlite.py` | 400 | 500 |\n| `api/mcp.py` | 400 | 500 |\n| `api/http.py` | 300 | 400 |\n| `main.py` | 150 | 200 |\n| **TOTAL** | **~2,000** | **~3,000** |\n\nCurrent codebase: 34,233 lines\nTarget: ~2,000 lines\n**Reduction: 94%**\n\n## Design Decisions\n\n### Why Not Separate `utils/`?\nYAGNI. If hashing is 10 lines, put it in `service.py`. If TOON is 50 lines, put it in `api/mcp.py`. Only extract when there's actual reuse.\n\n### Why Not `domain/` Folder?\nTwo files (memory.py, service.py) don't need a folder. Keep flat where possible.\n\n### Why `api/` Not `interfaces/`?\nShorter. Clearer. Same meaning.\n\n### Why Storage Factory in `__init__.py`?\nIt's 20 lines. Doesn't need its own file. Pattern: small factory lives with interface.\n",
  "fileStats": {
    "size": 6673,
    "lines": 184,
    "lastModified": "2025-12-30T12:53:33.089Z"
  },
  "comments": []
}
