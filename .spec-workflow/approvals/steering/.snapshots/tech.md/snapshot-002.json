{
  "id": "snapshot_1767096847469_rh7slw5z1",
  "approvalId": "approval_1767096636453_an0oaeil7",
  "approvalTitle": "Tech Steering Document - Python 3.13+, Qdrant Primary",
  "version": 2,
  "timestamp": "2025-12-30T12:14:07.469Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Technology Stack\n\n## Project Type\n\nMCP (Model Context Protocol) Server - A semantic memory service that provides persistent, searchable knowledge storage for AI assistants via the FastMCP protocol.\n\n## Core Technologies\n\n### Primary Language\n- **Language**: Python 3.13+\n- **Runtime**: CPython with optional CUDA support\n- **Package Management**: uv (fast, modern Python package manager)\n\n### Key Dependencies (POST-REMEDIATION)\n\n| Dependency | Purpose | Version |\n|------------|---------|---------|\n| `fastmcp>=2.13.0` | MCP protocol implementation | KEEP |\n| `qdrant-client>=1.7.0` | Vector database client | KEEP |\n| `sentence-transformers>=2.2.2` | Text embedding generation | KEEP |\n| `torch>=2.0.0` | Neural network backend | KEEP |\n| `pydantic>=2.0.0` | Data validation & settings | KEEP |\n| `pydantic-settings>=2.0.0` | Configuration management | KEEP |\n| `httpx>=0.24.0` | Async HTTP client | KEEP |\n| `click>=8.0.0` | CLI framework | KEEP |\n\n### Dependencies to DELETE\n\n| Dependency | Reason |\n|------------|--------|\n| `zeroconf>=0.130.0` | mDNS discovery - k8s handles this |\n| `authlib>=1.2.0` | OAuth - 3 CRITICAL vulns, unused |\n| `python-jose>=3.3.0` | OAuth JWT - unused |\n| `pypdf2>=3.0.0` | PDF ingestion - feature creep |\n| `chardet>=5.0.0` | Text detection - ingestion deleted |\n\n### Application Architecture\n\n**Current**: Monolithic god-class with 4 unused storage backends\n**Target**: Clean layered architecture\n\n```\n┌─────────────────────────────────────┐\n│          MCP Protocol Layer         │  ← FastMCP handles protocol\n├─────────────────────────────────────┤\n│          Service Layer              │  ← MemoryService (business logic)\n├─────────────────────────────────────┤\n│          Storage Layer              │  ← Qdrant (prod), SQLite (dev)\n└─────────────────────────────────────┘\n```\n\n### Data Storage\n\n| Environment | Backend | Purpose |\n|-------------|---------|---------|\n| Production | Qdrant | Vector database with persistence |\n| Development | SQLite-vec | Local dev, no external deps |\n| **DELETED** | Cloudflare | Not used |\n| **DELETED** | Hybrid | Not used, race conditions |\n\n**Vector Dimensions**: 768 (e5-base-v2 default)\n\n### External Integrations\n\n| Integration | Protocol | Status |\n|-------------|----------|--------|\n| MCP Clients | stdio/SSE | KEEP |\n| Qdrant | gRPC/HTTP | KEEP |\n| HTTP API | REST | KEEP (web/) |\n| mDNS | UDP Multicast | DELETE |\n| OAuth 2.1 | HTTP | DELETE |\n\n## Development Environment\n\n### Build & Development Tools\n\n| Tool | Purpose |\n|------|---------|\n| `uv` | Package management, virtual envs |\n| `ruff` | Linting + formatting (129 char line) |\n| `basedpyright` | Type checking (strict mode) |\n| `pytest` | Testing framework |\n| `pytest-asyncio` | Async test support |\n\n### Code Quality Standards\n\n```toml\n# pyproject.toml targets\n[tool.ruff]\nline-length = 129\ntarget-version = \"py313\"\n\n[tool.basedpyright]\ntypeCheckingMode = \"strict\"\n```\n\n### Version Control\n\n- **VCS**: Git\n- **Branching**: trunk-based with feature branches\n- **CI/CD**: Dagger (build/test) → Argo CD (deploy)\n\n## Deployment & Distribution\n\n### Container Strategy\n\n| Stage | Base Image | Size Target |\n|-------|-----------|-------------|\n| Build | python:3.13-slim | N/A |\n| Runtime | python:3.13-slim | <500MB |\n\n**Current size**: TBD (needs measurement)\n**Target**: <500MB\n\n### Kubernetes Deployment\n\n```yaml\n# Target deployment structure\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: mcp-memory\nspec:\n  replicas: 1  # Stateful, single replica\n  template:\n    spec:\n      containers:\n      - name: mcp-memory\n        resources:\n          requests:\n            memory: \"512Mi\"\n            cpu: \"250m\"\n          limits:\n            memory: \"2Gi\"\n            cpu: \"2000m\"\n```\n\n### Health Probes\n\n```yaml\nlivenessProbe:\n  httpGet:\n    path: /health\n    port: 8080\n  initialDelaySeconds: 30\n  periodSeconds: 10\n\nreadinessProbe:\n  httpGet:\n    path: /health\n    port: 8080\n  initialDelaySeconds: 5\n  periodSeconds: 5\n```\n\n## Technical Requirements & Constraints\n\n### Performance Requirements\n\n| Metric | Current | Target |\n|--------|---------|--------|\n| Embedding latency | TBD | TBD (benchmark needed) |\n| Memory store | TBD | TBD |\n| Semantic search | TBD | TBD |\n| Container startup | TBD | TBD |\n\n**Action**: Establish baselines before remediation, measure after.\n\n### Compatibility Requirements\n\n| Requirement | Specification |\n|-------------|---------------|\n| Python | 3.13+ |\n| MCP Protocol | 2.0+ |\n| Qdrant | 1.7+ |\n| Kubernetes | 1.28+ |\n| Architecture | amd64, arm64 |\n\n### Security Requirements\n\n**CRITICAL FIXES (Phase 0)**:\n\n1. **[SEC-001]** Anonymous access grants read-only, not admin\n2. **[SEC-002]** OAuth deleted entirely (3 CRITICAL vulns)\n3. **[SEC-003]** CORS default to `[]` not `['*']`\n4. **[SEC-004]** mDNS deleted (network exposure)\n\n**Ongoing**:\n- SecretStr for all sensitive config\n- Parameterized SQL queries (no injection)\n- API key authentication (simple, effective)\n- No timing attacks on secret comparison\n\n## Technical Decisions & Rationale\n\n### Decision Log\n\n| Decision | Rationale | Alternatives Rejected |\n|----------|-----------|----------------------|\n| Qdrant primary | Fast, ARM-optimized, gRPC | Cloudflare (latency), Hybrid (complexity) |\n| SQLite-vec dev | No external deps, portable | Docker Qdrant (heavyweight for dev) |\n| FastMCP | Modern, async, maintained | Legacy server.py (4K lines, god class) |\n| e5-base-v2 | No prefix complexity, fast | BGE (requires prompts), ONNX (disabled) |\n| uv | Fast, reliable, modern | pip (slow), poetry (bloated) |\n| pydantic-settings | Type-safe config, SecretStr | ENV parsing, yaml files |\n\n### Why NOT These Technologies\n\n| Tech | Reason Rejected |\n|------|-----------------|\n| OAuth 2.1 | 3 CRITICAL vulns, over-engineered for use case |\n| mDNS Discovery | k8s handles service discovery |\n| Document Ingestion | Feature creep, separate concern |\n| 4 Storage Backends | YAGNI, maintenance burden |\n| ONNX Embeddings | Disabled by default, complexity |\n| SSE Events | YAGNI, not used in production |\n\n## Known Limitations\n\n### Current (To Fix)\n\n| Limitation | Impact | Resolution |\n|------------|--------|------------|\n| ~45% dead code | Maintenance burden | Phase 1 deletion |\n| 15 config classes | Confusing | Phase 2 collapse |\n| 4 storage backends | Unused complexity | Phase 3 consolidation |\n| Dashboard status | Unknown | Audit, then fix or delete |\n\n### Accepted Trade-offs\n\n| Trade-off | Rationale |\n|-----------|-----------|\n| Single replica | Stateful service, Qdrant handles persistence |\n| CPU embeddings default | GPU optional, reduces complexity |\n| No OAuth | API key simpler, secure enough for use case |\n| No consolidation/forgetting | Premature optimization, can add later |\n",
  "fileStats": {
    "size": 7068,
    "lines": 237,
    "lastModified": "2025-12-30T12:10:26.259Z"
  },
  "comments": []
}
