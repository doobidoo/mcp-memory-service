version: '3.8'

services:
  mcp-memory:
    build:
      context: ../..
      dockerfile: deployment/oracle/Dockerfile
    container_name: mcp-memory
    restart: unless-stopped
    ports:
      - "8002:8000"  # Accessible on localhost (using 8002 locally to avoid conflict)
    volumes:
      - sqlite-data:/data
      - /mnt/c/Users/fish/.cache/huggingface:/home/mcp/.cache/huggingface
    environment:
      - MCP_MEMORY_STORAGE_BACKEND=sqlite_vec
      - MCP_MEMORY_SQLITE_DATABASE_PATH=/data/sqlite_vec.db
      - MCP_MEMORY_SQLITE_PRAGMAS=busy_timeout=15000,journal_mode=WAL,synchronous=NORMAL,cache_size=-2000000,mmap_size=2147483648
      - MCP_HTTP_HOST=0.0.0.0
      - MCP_HTTP_PORT=8000
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/api/health').raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # backup:
  #   image: rclone/rclone:latest
  #   container_name: mcp-memory-backup
  #   restart: unless-stopped
  #   volumes:
  #     - sqlite-data:/data:ro
  #     - ./rclone.conf:/config/rclone/rclone.conf:ro
  #   environment:
  #     - RCLONE_CONFIG=/config/rclone/rclone.conf
  #   command: >
  #     sh -c "while true; do
  #       echo '[INFO] Starting backup at $(date)'
  #       rclone sync /data r2:mcp-memory-backups \
  #         --log-level INFO \
  #         --transfers 4 \
  #         --checkers 8 \
  #         --fast-list
  #       echo '[SUCCESS] Backup completed at $(date)'
  #       sleep 21600
  #     done"
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '1'
  #         memory: 1G

volumes:
  sqlite-data:
    driver: local
